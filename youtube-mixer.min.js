function newRemix(){return{id:(new Date).getTime().toString(),title:"",videos:[]}}function onYouTubeIframeAPIReady(){YouTubeMixer.onYouTubeIframeAPIReady()}var defaultVideo={title:"",url:"",thumbnailUrl:"",startTimeInMs:0,endTimeInMs:0,comments:[]},YouTubeMixer;(function(n){function lt(){var t=document.createElement("script"),n;t.src="https://www.youtube.com/iframe_api",n=document.getElementsByTagName("script")[0],n.parentNode.insertBefore(t,n),$(function(){ri(),at()})}function at(){tt=$(".search__input").keydown(function(n){n.which===13&&ct()}),$(".search__button").click(ct),e=$(".search__results").hide().on("click",".search__results__item",ni);$(document).click(function(n){$(n.target).closest(".search__results").length||e.hide()}).on("click",".player__split",vt);it=$(".queue").on("click",".queue__item",ti),rt=$(".player__comments").click(function(){r&&r.getPlayerState()!==YT.PlayerState.PLAYING?r.playVideo():r&&r.pauseVideo()}).on("mouseenter click",".player__comments__comment",pt),et=$(".player__controls").on("change","input",function(n){var i=$(n.currentTarget),r=$(".player__controls input").index(i);r==0?t.startTimeInMs=i.val():t.endTimeInMs=i.val()});$(document).on("click",".seek-to",yt).on("change",".time-input",function(n){var t=$(n.currentTarget);t.prev(".seek-to").data("time",t.val())}).on("click",".take-now",function(n){var t=$(n.currentTarget);t.prev(".time-input").val(u()).trigger("change")});f=$(".remix__list"),ot=$(".remix__title").on("change",function(n){i.title=$(n.currentTarget).val()});$(".remix__save").on("click",function(){localStorage["remix-"+i.id]=JSON.stringify(i),l()});$(".remix__load").on("click",function(){var n=f.val();n&&c(JSON.parse(localStorage[n]))});$(".remix__delete").on("click",function(){var n=f.val();n&&(localStorage.removeItem(n),l())});$(".remix__new").on("click",function(){c(newRemix())});l(),ut=$(".comments__list").on("change","input",function(n){var i=$(n.currentTarget),r=$(".comments__list input").index(i),f=t.comments[Math.floor(r/2)];r&1?f.endTimeInMs=i.val():f.startTimeInMs=i.val(),d(u())}).on("change keyup","textarea",function(n){var i=$(n.currentTarget),r=$(".comments__list textarea").index(i),u=t.comments[r];u.text=i.val(),st()}).on("click",".comments__list__item__delete",function(n){var i=$(n.currentTarget),r=$(".comments__list .comments__list__item__delete").index(i);t.comments.splice(r,1),i.closest("tr").fadeOut(function(){o()})}),h=$(".comments__input").keydown(function(n){n.which===13&&ht(n)}),$(".comments__add").click(ht)}function vt(){if(t){var f=i.videos.indexOf(t),n=_.extend({},t),r=u();t.endTimeInMs=r,n.startTimeInMs=r,n.comments=[],i.videos.splice(f+1,0,n),p(),v()}}function yt(n){var t=Number($(n.currentTarget).data("time"));r.seekTo(t/1e3,!0)}function pt(n){var i=$(n.currentTarget);i.is(":data(draggable)")||i.resizable({stop:function(n,i){var r=t.comments[i.element.index()];r.width=i.size.width,r.height=i.size.height}}).draggable({containment:".player__comments",stop:function(n,i){var r=t.comments[i.helper.index()];r.top=i.position.top,r.left=i.position.left}})}function wt(){r=new YT.Player("player__iframe",{height:390,width:640,origin:location.href,events:{onReady:bt,onStateChange:kt},playerVars:{wmode:"opaque"}})}function c(n){i=n,s(i.videos[0]||defaultVideo),dt()}function bt(){setInterval(gt,200),t&&s(t)}function kt(){}function dt(){ot.val(i.title),v(),p(),o()}function l(){var n,t;f.empty();for(n in localStorage)n.indexOf("remix-")===0&&(t=JSON.parse(localStorage[n]),f.append('<option value="'+n+'">'+t.title+" ("+n+")<\/option>"))}function u(){return!r||!r.getCurrentTime?0:Math.floor(r.getCurrentTime()*1e3)}function v(){a=a||Handlebars.compile($("#queue-item-template").html()),it.html(i.videos.map(function(n){return a(n)}).join(""))}function p(){y=y||Handlebars.compile($("#current-video-template").html()),et.html(y(t))}function st(){w=w||Handlebars.compile($("#player-comment-template").html()),rt.html(t.comments.map(function(n){return w(n)}).join("")),ft=$(".player__comments__comment"),d(u())}function o(){b=b||Handlebars.compile($("#comment-list-item-template").html()),ut.html(t.comments.map(function(n){return b(n)}).join("")),st()}function gt(){var n,f;r&&t&&(n=u(),n!==k&&(n>=t.endTimeInMs&&r.getPlayerState()===YT.PlayerState.PLAYING&&(r.pauseVideo(),$(".queue__autoplay").is(":checked")&&(f=i.videos.indexOf(t),f>=0&&f<i.videos.length-1&&s(i.videos[f+1]))),d(n),k=n))}function d(n){t.comments.forEach(function(t,i){var r=n>=t.startTimeInMs&&n<=t.endTimeInMs,u=ft.eq(i).toggle(r)})}function ni(n){var t=$(n.currentTarget).data("video");if(!t)throw new Error("Video does not exist.");i.videos.push(t),v()}function ti(n){var t=i.videos[$(n.currentTarget).closest(".queue__item").index()];s(t)}function s(n){if(!n)throw new Error("Video does not exist.");r.cueVideoByUrl(n.url,n.startTimeInMs/1e3),n!==t&&(t=n,p(),o())}function ht(n){var r=h.val(),i;h.val(""),i=Math.floor(u()/1e3)*1e3,t.comments.push({text:r,startTimeInMs:i,endTimeInMs:i+3e3,top:0,left:0,width:100,height:20}),t.comments.sort(function(n,t){return n.startTimeInMs-t.startTimeInMs}),o(),n.preventDefault()}function ct(){var n=encodeURIComponent(tt.val());$.getJSON("https://gdata.youtube.com/feeds/api/videos?q="+n+"&alt=json-in-script&v=2&callback=?",{},function(n){var t=n.feed.entry.map(function(n){console.log(n);return{title:n.title.$t,url:n.content.src,thumbnailUrl:n.media$group.media$thumbnail.filter(function(n){return n.yt$name==="default"})[0].url,comments:[],startTimeInMs:0,endTimeInMs:n.media$group.yt$duration.seconds*1e3}});ii(t)})}function ii(n){g=g||Handlebars.compile($("#search-result-template").html()),e.empty().show(),n.forEach(function(n){$(g(n)).data("video",n).appendTo(e)})}function ri(){Handlebars.registerHelper("time_input",function(n){return nt=nt||Handlebars.compile($("#time-input-template").html()),new Handlebars.SafeString(nt({timeInMs:n}))})}var tt,e,it,rt,ut,h,ft,et,ot,f,i=newRemix(),t=defaultVideo,r,a,y,w,b,k,g,nt;n.init=lt,n.onYouTubeIframeAPIReady=wt,n.load=c,k=null})(YouTubeMixer||(YouTubeMixer={}))